{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["import { JsPsych, JsPsychPlugin, ParameterType, TrialType } from \"jspsych\";\n\nconst info = <const>{\n  name: \"html-audio-response\",\n  parameters: {\n    /** The HTML string to be displayed */\n    stimulus: {\n      type: ParameterType.HTML_STRING,\n      default: undefined,\n    },\n    /** How long to show the stimulus. */\n    stimulus_duration: {\n      type: ParameterType.INT,\n      default: null,\n    },\n    /** How long to show the trial. */\n    recording_duration: {\n      type: ParameterType.INT,\n      default: 2000,\n    },\n    show_done_button: {\n      type: ParameterType.BOOL,\n      default: true,\n    },\n    done_button_label: {\n      type: ParameterType.STRING,\n      default: \"Continue\",\n    },\n    record_again_button_label: {\n      type: ParameterType.STRING,\n      default: \"Record again\",\n    },\n    accept_button_label: {\n      type: ParameterType.STRING,\n      default: \"Continue\",\n    },\n    allow_playback: {\n      type: ParameterType.BOOL,\n      default: false,\n    },\n    save_audio_url: {\n      type: ParameterType.BOOL,\n      default: false,\n    },\n  },\n};\n\ntype Info = typeof info;\n\n/**\n * html-audio-response\n * jsPsych plugin for displaying a stimulus and recording an audio response through a microphone\n * @author Josh de Leeuw\n * @see {@link https://www.jspsych.org/plugins/jspsych-html-audio-response/ html-audio-response plugin documentation on jspsych.org}\n */\nclass HtmlAudioResponsePlugin implements JsPsychPlugin<Info> {\n  static info = info;\n  private stimulus_start_time;\n  private recorder_start_time;\n  private recorder: MediaRecorder;\n  private audio_url;\n  private response;\n  private load_resolver;\n  private rt: number = null;\n  private start_event_handler;\n  private stop_event_handler;\n  private data_available_handler;\n  private recorded_data_chunks = [];\n\n  constructor(private jsPsych: JsPsych) {}\n\n  trial(display_element: HTMLElement, trial: TrialType<Info>) {\n    this.recorder = this.jsPsych.pluginAPI.getMicrophoneRecorder();\n\n    this.setupRecordingEvents(display_element, trial);\n\n    this.startRecording();\n  }\n\n  private showDisplay(display_element, trial) {\n    const ro = new ResizeObserver((entries, observer) => {\n      this.stimulus_start_time = performance.now();\n      observer.unobserve(display_element);\n      //observer.disconnect();\n    });\n\n    ro.observe(display_element);\n\n    let html = `<div id=\"jspsych-html-audio-response-stimulus\">${trial.stimulus}</div>`;\n\n    if (trial.show_done_button) {\n      html += `<p><button class=\"jspsych-btn\" id=\"finish-trial\">${trial.done_button_label}</button></p>`;\n    }\n\n    display_element.innerHTML = html;\n  }\n\n  private hideStimulus(display_element: HTMLElement) {\n    const el: HTMLElement = display_element.querySelector(\"#jspsych-html-audio-response-stimulus\");\n    if (el) {\n      el.style.visibility = \"hidden\";\n    }\n  }\n\n  private addButtonEvent(display_element, trial) {\n    const btn = display_element.querySelector(\"#finish-trial\");\n    if (btn) {\n      btn.addEventListener(\"click\", () => {\n        const end_time = performance.now();\n        this.rt = Math.round(end_time - this.stimulus_start_time);\n        this.stopRecording().then(() => {\n          if (trial.allow_playback) {\n            this.showPlaybackControls(display_element, trial);\n          } else {\n            this.endTrial(display_element, trial);\n          }\n        });\n      });\n    }\n  }\n\n  private setupRecordingEvents(display_element, trial) {\n    this.data_available_handler = (e) => {\n      if (e.data.size > 0) {\n        this.recorded_data_chunks.push(e.data);\n      }\n    };\n\n    this.stop_event_handler = () => {\n      const data = new Blob(this.recorded_data_chunks, { type: \"audio/webm\" });\n      this.audio_url = URL.createObjectURL(data);\n      const reader = new FileReader();\n      reader.addEventListener(\"load\", () => {\n        const base64 = (reader.result as string).split(\",\")[1];\n        this.response = base64;\n        this.load_resolver();\n      });\n      reader.readAsDataURL(data);\n    };\n\n    this.start_event_handler = (e) => {\n      // resets the recorded data\n      this.recorded_data_chunks.length = 0;\n\n      this.recorder_start_time = e.timeStamp;\n      this.showDisplay(display_element, trial);\n      this.addButtonEvent(display_element, trial);\n\n      // setup timer for hiding the stimulus\n      if (trial.stimulus_duration !== null) {\n        this.jsPsych.pluginAPI.setTimeout(() => {\n          this.hideStimulus(display_element);\n        }, trial.stimulus_duration);\n      }\n\n      // setup timer for ending the trial\n      if (trial.recording_duration !== null) {\n        this.jsPsych.pluginAPI.setTimeout(() => {\n          // this check is necessary for cases where the\n          // done_button is clicked before the timer expires\n          if (this.recorder.state !== \"inactive\") {\n            this.stopRecording().then(() => {\n              if (trial.allow_playback) {\n                this.showPlaybackControls(display_element, trial);\n              } else {\n                this.endTrial(display_element, trial);\n              }\n            });\n          }\n        }, trial.recording_duration);\n      }\n    };\n\n    this.recorder.addEventListener(\"dataavailable\", this.data_available_handler);\n\n    this.recorder.addEventListener(\"stop\", this.stop_event_handler);\n\n    this.recorder.addEventListener(\"start\", this.start_event_handler);\n  }\n\n  private startRecording() {\n    this.recorder.start();\n  }\n\n  private stopRecording() {\n    this.recorder.stop();\n    return new Promise((resolve) => {\n      this.load_resolver = resolve;\n    });\n  }\n\n  private showPlaybackControls(display_element, trial) {\n    display_element.innerHTML = `\n      <p><audio id=\"playback\" src=\"${this.audio_url}\" controls></audio></p>\n      <button id=\"record-again\" class=\"jspsych-btn\">${trial.record_again_button_label}</button>\n      <button id=\"continue\" class=\"jspsych-btn\">${trial.accept_button_label}</button>\n    `;\n\n    display_element.querySelector(\"#record-again\").addEventListener(\"click\", () => {\n      // release object url to save memory\n      URL.revokeObjectURL(this.audio_url);\n      this.startRecording();\n    });\n    display_element.querySelector(\"#continue\").addEventListener(\"click\", () => {\n      this.endTrial(display_element, trial);\n    });\n\n    // const audio = display_element.querySelector('#playback');\n    // audio.src =\n  }\n\n  private endTrial(display_element, trial) {\n    // clear recordering event handler\n\n    this.recorder.removeEventListener(\"dataavailable\", this.data_available_handler);\n    this.recorder.removeEventListener(\"start\", this.start_event_handler);\n    this.recorder.removeEventListener(\"stop\", this.stop_event_handler);\n\n    // kill any remaining setTimeout handlers\n    this.jsPsych.pluginAPI.clearAllTimeouts();\n\n    // gather the data to store for the trial\n    var trial_data: any = {\n      rt: this.rt,\n      stimulus: trial.stimulus,\n      response: this.response,\n      estimated_stimulus_onset: Math.round(this.stimulus_start_time - this.recorder_start_time),\n    };\n\n    if (trial.save_audio_url) {\n      trial_data.audio_url = this.audio_url;\n    } else {\n      URL.revokeObjectURL(this.audio_url);\n    }\n\n    // clear the display\n    display_element.innerHTML = \"\";\n\n    // move on to the next trial\n    this.jsPsych.finishTrial(trial_data);\n  }\n}\n\nexport default HtmlAudioResponsePlugin;\n"],"names":[],"mappings":"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"}